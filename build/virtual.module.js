/*!
 * Virtual DOM based JavaScript library for building dynamic websites.
 * Copyright (C) 2022 Amin NAIRI
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */
const t=t=>"[object String]"===Object.prototype.toString.call(t),e=t=>{const e=Object.prototype.toString.call(t);return"[object Undefined]"===e||"[object Null]"===e},r=t=>"[object Object]"===Object.prototype.toString.call(t),n=(t,e)=>r=>Object.prototype.hasOwnProperty.call(r,t)&&e(r[t]),o=t=>"[object Array]"===Object.prototype.toString.call(t),i=e=>{return r(e)&&(i=[n("identifier",t),n("name",t),n("children",o),n("attributes",r)],t=>r(tagret)&&i.every((e=>e(t))));var i},a=t=>{const e=Object.prototype.toString.call(t);return"[object Function]"===e||"[object AsyncFunction]"===e},c=t=>(o(t)?t.forEach((t=>{c(t)})):r(t)&&Object.values(t).forEach((t=>{c(t)})),Object.freeze(t),t),l=t=>0===t.length?t:[...t].reduce(((t,e)=>e.match(/[A-Z]/)?""===t?e.toLowerCase():`${t}-${e.toLowerCase()}`:`${t}${e}`),""),d=({name:t,key:e,attributes:r,children:n})=>({identifier:window.crypto.randomUUID(),name:t,key:e,attributes:r,children:n}),u=e=>{if(t(e))return document.createTextNode(e);if(!i(e))return;const{identifier:r,name:n,attributes:o,children:a}=e,c=e.attributes.xmlns?document.createElementNS(e.attributes.xmlns,e.name):document.createElement(n);return Object.entries(o).forEach((([t,r])=>{"xmlns"!==t&&(e.attributes.xmlns?c.setAttribute(l(t),r):c[t]=r)})),a.forEach((t=>{c.appendChild(u(t))})),c.dataset.virtual=r,c},s=t=>{i(t)&&(a(t.attributes.onbeforeload)&&t.attributes.onbeforeload(),t.children.forEach((t=>{s(t)})))},b=t=>{i(t)&&(a(t.attributes.onafterload)&&t.attributes.onafterload(),t.children.forEach((t=>{b(t)})))},f=t=>{i(t)&&(a(t.attributes.onbeforeunload)&&t.attributes.onbeforeunload(),t.children.forEach((t=>{f(t)})))},h=t=>{i(t)&&(a(t.attributes.onafterunload)&&t.attributes.onafterunload(),t.children.forEach((t=>{h(t)})))},p=(r,n)=>o=>{if(e(o))return;if(e(r))return e(n)?void 0:(o.appendChild(u(n)),void load(n));if(t(r)){if(t(n)){if(r===n)return;return void(o.textContent=n)}return e(n)?void(o.textContent=""):(o.innerHTML="",o.appendChild(u(n)),void load(n))}if(!i(r))return;const a=document.querySelector(`[data-virtual="${r.identifier}"]`);if(a instanceof window.Element){if(e(n))return unload(n),void o.removeChild(a);if(t(n))return o.innerHTML="",void(o.textContent=n);if(i(n)){if(r.name!==n.name||r.key!==n.key)return f(r),s(n),o.replaceChild(u(n),a),h(r),void b(n);Object.entries(r.attributes).forEach((([t,r])=>{const o=n.attributes[t];e(o)?a.removeAttribute(t):r!==o&&(n.attributes.xmlns?a.setAttribute(l(t),o):a[t]=o)})),Object.entries(n.attributes).forEach((([t,o])=>{const i=r.attributes[t];e(i)&&(n.attributes.xmlns?a.setAttribute(l(t),o):a[t]=o)})),n.children.forEach(((t,e)=>{const n=r.children[e];p(n,t)(a)})),r.children.forEach(((t,e)=>{const r=n.children[e];if(!r){p(t,r)(a)}})),n.identifier=r.identifier}}},m=t=>{let e;const r=({type:n,payload:o})=>{const i=t.update(t.state,{type:n,payload:o}),a=t.view(c(i),c(r));p(e,a)(t.element),e=a,t.state=i};e=t.view(c(t.state),c(r));return p(null,e)(t.element),r};export{m as createApplication,d as createVirtualElement};
